---

- name: Deploy Firefly III

  hosts: fireflyiii

  vars:

    # Firefly III facts
    # Ensure values are also set in templates/fireflyiii/docker-compose.yaml.j2
    # TODO: Ensure variables set here are used in the docker-compose file
    fireflyiii_image_tag: version-6.3.2
    fireflyiii_service_name: fireflyiii
    fireflyiii_service_port: 8080
    fireflyiii_db_backup_volume_name: fireflyiii_db_backup

    # Grist facts
    grist_image: gristlabs/grist:v1.7.3
    grist_service_name: grist
    grist_service_port: 8484
    grist_data_volume_name: grist_data

  tasks:

    - name: Load homelab vars
      ansible.builtin.include_vars:
        file: vars/homelab_env.yaml

    - name: Deploy a containerised instance of Firefly III
      ansible.builtin.include_tasks:
        file: tasks/deploy-fireflyiii.yaml

    - name: Deploy a containerised instance of Docker Volume Backup
      ansible.builtin.include_tasks:
        file: tasks/deploy-docker-volume-backup.yaml
      vars:
        docker_volume_backup_volume_to_backup:
          - "{{ fireflyiii_db_backup_volume_name }}:/backup/fireflyiii_db-backup:ro"
        docker_volume_backup_backup_label: "{{ fireflyiii_service_name }}-db"
        docker_volume_backup_backup_retention_days: 7

    - name: Deploy a containerised instance of Grist
      ansible.builtin.include_tasks:
        file: tasks/deploy-grist.yaml
